name: SecureShield CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# Cancel redundant runs on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:

  # ──────────────────────────────────────────────
  # Stage 1: Rust / Wasm unit tests
  # ──────────────────────────────────────────────
  wasm-tests:
    name: "Rust / Wasm Tests"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo registry & build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            wasm/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('wasm/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Run Wasm unit tests
        run: |
          cd wasm
          cargo test --verbose

  # ──────────────────────────────────────────────
  # Stage 2: Python / FastAPI integration tests
  # ──────────────────────────────────────────────
  backend-tests:
    name: "Backend Integration Tests"
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: main_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U user -d main_db"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Run backend tests (pytest)
        env:
          # Override conftest.py's SQLite default so CI runs against real Postgres
          DATABASE_URL: postgresql+asyncpg://user:password@localhost:5432/main_db
          ADMIN_API_KEY: test-admin-key
          OFFLINE_TOKEN_SECRET: test-offline-secret-for-jwt-hs256!
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
        run: |
          cd backend
          pytest tests/ -v --tb=short

  # ──────────────────────────────────────────────
  # Stage 3: Playwright E2E tests
  # Runs only after wasm + backend both pass
  # ──────────────────────────────────────────────
  frontend-e2e:
    name: "Frontend E2E Tests (Playwright)"
    needs: [ wasm-tests, backend-tests ]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Start only DB + API (not the UI container — playwright launches its own dev server)
      - name: Start backend services (DB + API)
        run: docker compose up -d db backend

      - name: Wait for API to be healthy
        run: |
          timeout 60 bash -c \
            'until curl -sf http://localhost:8001/health | grep -q healthy; do
               echo "waiting for API..."; sleep 3
             done'

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Install Playwright + Chromium
        run: cd frontend && npx playwright install chromium --with-deps

      - name: Run Playwright E2E tests
        env:
          CI: "true"
          # Playwright's webServer (npm run dev) will inherit this env var
          NEXT_PUBLIC_API_URL: http://localhost:8001
        run: cd frontend && npx playwright test --reporter=github

      - name: Upload Playwright report on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 7
