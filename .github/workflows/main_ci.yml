name: SecureShield CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# Cancel redundant runs on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:

  # ──────────────────────────────────────────────
  # Stage 1: Rust / Wasm unit tests
  # ──────────────────────────────────────────────
  wasm-tests:
    name: "Rust / Wasm Tests"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo registry & build
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            wasm/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('wasm/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Run Wasm unit tests
        run: |
          cd wasm
          cargo test --verbose

  # ──────────────────────────────────────────────
  # Stage 2: Python / FastAPI integration tests
  # ──────────────────────────────────────────────
  backend-tests:
    name: "Backend Integration Tests"
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: main_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U user -d main_db"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Cache pip packages
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Run backend tests + coverage (Postgres)
        env:
          # Override conftest.py's SQLite default so CI runs against real Postgres
          DATABASE_URL: postgresql+asyncpg://user:password@localhost:5432/main_db
          RATE_LIMIT_ENABLED: "false"
          ADMIN_API_KEY: test-admin-key-for-ci-not-production
          OFFLINE_TOKEN_SECRET: test-offline-secret-for-jwt-hs256!
          VAULT_TOKEN_SECRET: test-vault-token-secret-for-jwt32!
          SUPER_ADMIN_KEY: test-super-admin-key-ci
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          # VAULT_MASTER_KEY must be base64(32-byte key) — conftest sets a test value
          # via setdefault, but we pin it here so it's visible in the CI log.
          VAULT_MASTER_KEY: dGVzdF92YXVsdF8zMmJ5dGVfa2V5X2Zvcl90ZXN0cyE=
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: us-east-1
          S3_BUCKET: test-secureshield-vault
        run: |
          cd backend
          pytest tests/ -v --tb=short \
            --cov=. --cov-config=.coveragerc \
            --cov-report=term-missing:skip-covered \
            --cov-report=xml:coverage.xml \
            --junitxml=test-results.xml

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-postgres
          path: backend/coverage.xml
          retention-days: 30

  # ──────────────────────────────────────────────
  # Stage 3: Playwright E2E tests
  # Runs only after wasm + backend both pass
  # ──────────────────────────────────────────────
  frontend-e2e:
    name: "Frontend E2E Tests (Playwright)"
    needs: [ wasm-tests, backend-tests ]
    runs-on: ubuntu-latest

    # Managed services — GitHub Actions starts these containers and waits for
    # them to pass their health checks before running any steps.
    # Using services (instead of docker compose) avoids the 3–5 min image-build
    # penalty on cold runners and matches the approach in backend-tests.
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: main_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U user -d main_db"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Cache pip packages
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install backend dependencies
        run: cd backend && pip install -r requirements.txt

      # Start uvicorn in the background.  No image build — starts in ~3 s.
      # REDIS_URL defaults to redis://localhost:6379/0 in redis_service.py so
      # it does not need to be set explicitly here.
      - name: Start backend API
        env:
          DATABASE_URL: postgresql+asyncpg://user:password@localhost:5432/main_db
          RATE_LIMIT_ENABLED: "false"
          ADMIN_API_KEY: test-admin-key-for-ci-not-production
          OFFLINE_TOKEN_SECRET: test-offline-secret-for-jwt-hs256!
          VAULT_TOKEN_SECRET: test-vault-token-secret-for-jwt32!
          SUPER_ADMIN_KEY: test-super-admin-key-ci
          VAULT_MASTER_KEY: dGVzdF92YXVsdF8zMmJ5dGVfa2V5X2Zvcl90ZXN0cyE=
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: us-east-1
          S3_BUCKET: test-secureshield-vault
        run: |
          cd backend
          uvicorn main:app --host 0.0.0.0 --port 8001 &
          echo $! > /tmp/uvicorn.pid

      - name: Wait for API to be healthy
        run: |
          timeout 60 bash -c \
            'until curl -sf http://localhost:8001/health | grep -q healthy; do
               echo "waiting for API..."; sleep 2
             done'

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Install Playwright + Chromium
        run: cd frontend && npx playwright install chromium --with-deps

      - name: Run Playwright E2E tests
        env:
          CI: "true"
          # Playwright's webServer (npm run dev) will inherit this env var
          NEXT_PUBLIC_API_URL: http://localhost:8001
        run: cd frontend && npx playwright test --reporter=github

      - name: Upload Playwright report on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 7
