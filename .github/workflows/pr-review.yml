name: PR Review Checks

# Runs on every pull-request push.
# Gives rapid (<3 min) feedback without a full Postgres/Docker stack:
#   1. Python lint   (ruff)
#   2. TypeScript lint  (ESLint)
#   3. TypeScript types  (tsc --noEmit)
#   4. Backend tests    (SQLite ‚Äî no DB service required)
#   5. PR summary comment ‚Äî posted / updated after all jobs finish

on:
  pull_request:
    branches: [main, master]
    types: [opened, synchronize, reopened]

# Cancel previous run on the same PR when a new commit is pushed
concurrency:
  group: pr-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # 1. Python linting ‚Äî ruff (10√ó faster than flake8)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  lint-python:
    name: "Lint ¬∑ Python (ruff)"
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.ruff.outcome }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff
        id: ruff
        run: ruff check backend/ --output-format=github
        continue-on-error: true   # collect result; gate is in pr-comment job

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # 2. TypeScript lint ‚Äî ESLint (via next lint)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  lint-ts:
    name: "Lint ¬∑ TypeScript (ESLint)"
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.eslint.outcome }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci --prefix frontend

      - name: ESLint via next lint
        id: eslint
        run: npm run lint --prefix frontend
        continue-on-error: true

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # 3. TypeScript type-check
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  typecheck-ts:
    name: "Types ¬∑ TypeScript (tsc)"
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.tsc.outcome }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci --prefix frontend

      - name: tsc --noEmit
        id: tsc
        # Skip wasm/pkg imports that only exist after a build
        run: npx tsc --noEmit --project frontend/tsconfig.json 2>&1 | grep -v wasm || true
        continue-on-error: true

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # 4. Backend tests ‚Äî SQLite (no Postgres service, fast)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  backend-tests-fast:
    name: "Tests ¬∑ Backend (SQLite)"
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.pytest.outcome }}
      coverage: ${{ steps.pytest.outputs.COVERAGE_PCT }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: pytest + coverage (SQLite)
        id: pytest
        env:
          DATABASE_URL: sqlite+aiosqlite:///./test_drm.db
          RATE_LIMIT_ENABLED: "false"
          ADMIN_API_KEY: test-admin-key-for-ci-not-production
          OFFLINE_TOKEN_SECRET: test-offline-secret-for-jwt-hs256!
          VAULT_TOKEN_SECRET: test-vault-token-secret-for-jwt32!
          SUPER_ADMIN_KEY: test-super-admin-key-ci
          VAULT_MASTER_KEY: dGVzdF92YXVsdF8zMmJ5dGVfa2V5X2Zvcl90ZXN0cyE=
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: us-east-1
          S3_BUCKET: test-secureshield-vault
        run: |
          cd backend
          pytest tests/ -v --tb=short \
            --cov=. --cov-config=.coveragerc \
            --cov-report=term-missing:skip-covered \
            --cov-report=xml:coverage.xml \
            --cov-report=json:coverage.json \
            --junitxml=test-results.xml
          # Extract total coverage % and expose as step output
          PCT=$(python -c "
          import json, sys
          d = json.load(open('coverage.json'))
          print(f\"{d['totals']['percent_covered']:.1f}%\")
          ")
          echo "COVERAGE_PCT=${PCT}" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload test + coverage results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: backend-test-results
          path: |
            backend/test-results.xml
            backend/coverage.xml
          retention-days: 7

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # 5. Post / update a single PR comment with all check results
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  pr-comment:
    name: "Post Review Summary"
    needs: [lint-python, lint-ts, typecheck-ts, backend-tests-fast]
    if: always()    # run even when prior jobs fail
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Build & upsert PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const icon = (outcome) =>
              outcome === 'success' ? '‚úÖ' : outcome === 'failure' ? '‚ùå' : '‚ö†Ô∏è';

            const lint_py   = '${{ needs.lint-python.outputs.result }}';
            const lint_ts   = '${{ needs.lint-ts.outputs.result }}';
            const types_ts  = '${{ needs.typecheck-ts.outputs.result }}';
            const tests     = '${{ needs.backend-tests-fast.outputs.result }}';
            const coverage  = '${{ needs.backend-tests-fast.outputs.coverage }}' || 'n/a';
            // Coverage badge: green ‚â•80%, yellow ‚â•60%, red <60%
            const pct = parseFloat(coverage);
            const covIcon = isNaN(pct) ? '‚ö™' : pct >= 80 ? 'üü¢' : pct >= 60 ? 'üü°' : 'üî¥';

            const allPassed = [lint_py, lint_ts, types_ts, tests]
              .every(r => r === 'success');

            const runUrl =
              `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const body = [
              '## üîç PR Review Checks',
              '',
              `| Check | Result |`,
              `|---|:---:|`,
              `| Python lint (ruff) | ${icon(lint_py)} |`,
              `| TypeScript lint (ESLint) | ${icon(lint_ts)} |`,
              `| TypeScript types (tsc) | ${icon(types_ts)} |`,
              `| Backend tests (SQLite) | ${icon(tests)} |`,
              `| Test coverage | ${covIcon} ${coverage} |`,
              '',
              allPassed
                ? '**All checks passed** ‚Äî ready to review üöÄ'
                : '**One or more checks failed.** Click the check names above for details.',
              '',
              `[View full run](${runUrl}) ¬∑ _Updated at ${new Date().toUTCString()}_`,
              '',
              '<!-- secureshield-pr-review -->',
            ].join('\n');

            const MARKER = '<!-- secureshield-pr-review -->';
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c => c.body.includes(MARKER));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
